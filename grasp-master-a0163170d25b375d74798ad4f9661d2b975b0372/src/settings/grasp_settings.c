/*
 *  Copyright 2016 CNRS & Universite Lille 1. All rights reserved.
 *  
 *  Licensed under the GRASP Open Source License V1.0 (see LICENSE file)
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <assert.h>
#include "grasp_settings.h"
#include "grasp_settings_data_types.h"
#include "yamlsettings/yamlsettings_validators.h"
#include "yamlsettings/yamlsettings_dictionary.h"
#include "yamlsettings/yamlsettings_data_types.h"
#include "yamlsettings/yamlsettings_assign_data.h"
#include "grasp_settings_assign_data.h"
#include "grasp_settings_validators.h"
#include "yamlsettings/yamlsettings.h"
#include "grasp_settings_data_types.h"
#include <grasp/utils.h>
#include "../global/grasp_compilation_information.h"
#include "../input/grasp_input_load_functions.h" // For loading input driver settings.
#include "../output/grasp_output_load_function.h"
#include "../output/grasp_output_stream.h"


#include <grasp/utils.h>


// definition of private functions used later
// This function wraps yamlsettings_copy_parameter from libyamlsettings library
// adding the functionaly to add classification block for extension settings.
typedef enum { GRASP_NO_EXTENSION, GRASP_EXTENSION_DRIVER, GRASP_EXTENSION_TRANSFORMER, GRASP_EXTENSION_SEGMENT_FUNCTION, GRASP_EXTENSION_CURRENT_FUNCTION, GRASP_EXTENSION_TILE_FUNCTION } grasp_settings_type_parameter;
void grasp_settings_copy_parameter(yamlsettings_parameter *origin, yamlsettings_parameter *dest, grasp_settings_type_parameter extension_type, const char *extension_name);

yamlsettings_dictionary_t *grasp_settings_dictionary_get(grasp_settings *settings){

    // Static definition of a dictionary
    yamlsettings_parameter settings_global[]= {
         /*                 name                                                                                                                     , memory direction                               , counter memory direction              , func to set variable type (length of value)             , initial value                               ,  number of elements          , allow_array             , parameter description                                                                                                                                                                                                                                                                                                                ,                 validator 1                 ,                   validator 2                         ,                    validator 3                            , {input function, output function, assigned}   */
         {"help"                                                                                                                                     , &settings->settings.help                       , NULL                                  , YS_DATA_TYPE_STRING(_GBL_FILE_PATH_LEN)                 , {ys_d_all,{"."                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "Shows this help information"                                                                                                                                                                                                                                                                                                        , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },         
         {"version"                                                                                                                                  , &settings->settings.version                    , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Shows GRASP code version information and stops"                                                                                                                                                                                                                                                                                     , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },         
         {"global.resources"                                                                                                                         , &settings->global.resources_path               , NULL                                  , YS_DATA_TYPE_FOLDER_PATH(_GBL_FILE_PATH_LEN)            , {ys_d_all,{RESOURCES_PREFIX                            }}, {0,{}}                       , YS_PARAM_SCALAR         , "Path to framework resources folder"                                                                                                                                                                                                                                                                                                 , {                                            {yamlsettings_validator_directory  , {           }  }                                                             },YAMLSETTINGS_END_VAR  },
    };
    yamlsettings_parameter settings_retrieval[]= {
         {"retrieval.general.path_to_internal_files"                                                                                                 , &settings->retrieval.DLSF.internal_file_path   , NULL                                  , GRASP_DATA_TYPE_FORTRAN_FOLDER_PATH(_GBL_FILE_PATH_LEN) , {ys_d_all,{RESOURCES_PREFIX"/kernels/"                 }}, {0,{}}                       , YS_PARAM_SCALAR         , "Path to internal data files"                                                                                                                                                                                                                                                                                                        , {                                            {grasp_settings_validator_directory_fortran , {           }  }                                                    },YAMLSETTINGS_END_VAR  },         
         {"retrieval.convergence.stop_before_performing_retrieval"                                                                                   , &settings->retrieval.ISTOP                     , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"true"                                      }}, {0,{}}                       , YS_PARAM_SCALAR         , "Define how the code is run (true=only forward model, false=full inversion)"                                                                                                                                                                                                                                                         , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },                           
         {"retrieval.convergence.minimization_convention"                                                                                            , &settings->retrieval.KL                        , NULL                                  , GRASP_DATA_TYPE_MINIMIZATION                            , {ys_d_all,{"absolute"                                  }}, {0,{}}                       , YS_PARAM_SCALAR         , "Minimization in absolute or logarithm space"                                                                                                                                                                                                                                                                                        , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.convergence.threshold_for_stopping_Q_iterations"                                                                                , &settings->retrieval.EPSQ                      , NULL                                  , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"0.000000e+00"                              }}, {0,{}}                       , YS_PARAM_SCALAR         , "Threshold for stopping q - iterations: once the change in the residual smaller than this parameter the iterations are stopped"                                                                                                                                                                                                      , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.convergence.scale_for_finite_difference"                                                                                        , &settings->retrieval.DL                        , NULL                                  , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"0.000000e+00"                              }}, {0,{}}                       , YS_PARAM_SCALAR         , "Defines DL for calculations of derivatives: (f(x+DL)-f(x))/DL"                                                                                                                                                                                                                                                                      , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },                  
         {"retrieval.convergence.threshold_for_stopping"                                                                                             , &settings->retrieval.EPSP                      , NULL                                  , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"0.000000e+00"                              }}, {0,{}}                       , YS_PARAM_SCALAR         , "Threshold for stopping p - iterations: once the change in the residual smaller than this parameter the iterations stops"                                                                                                                                                                                                            , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.convergence.normal_system_solver"                                                                                               , &settings->retrieval.IMQ                       , NULL                                  , GRASP_DATA_TYPE_IMQ                                     , {ys_d_all,{"singular_value_decomposition"              }}, {0,{}}                       , YS_PARAM_SCALAR         , "Defines the method to solve normal system"                                                                                                                                                                                                                                                                                          , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.convergence.maximum_iterations_of_Levenberg-Marquardt"                                                                          , &settings->retrieval.IPSTOP                    , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "The maximum number of ip iterations where Levenberg-Marquardt correction is applied"                                                                                                                                                                                                                                                , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.convergence.maximum_iterations_for_stopping"                                                                                    , &settings->retrieval.MAXP                      , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"99"                                        }}, {0,{}}                       , YS_PARAM_SCALAR         , "Maximum number of iterations performed in the retrieval before stop"                                                                                                                                                                                                                                                                , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },                           
         {"retrieval.convergence.shift_for_applying_logarithm_to_negative_values"                                                                    , &settings->retrieval.SHIFT                     , NULL                                  , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"1.000000e+00"                              }}, {0,{}}                       , YS_PARAM_SCALAR         , "This value (usually 1) is added to negative parameters in order to be able to apply logarithmic transformations"                                                                                                                                                                                                                    , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },         
         {"retrieval.regime_of_multipixel_constraints.inversion_regime"                                                                              , &settings->retrieval.IPFP.INVSING              , NULL                                  , GRASP_DATA_TYPE_INVSING                                 , {ys_d_all,{"single_pixel"                              }}, {0,{}}                       , YS_PARAM_SCALAR         , "Flag for single multi-pixel retrieval (VALUES)"                                                                                                                                                                                                                                                                                     , { {yamlsettings_validator_mandatory,{}}                                                                                                                        },YAMLSETTINGS_END_VAR  },
         {"retrieval.regime_of_multipixel_constraints.time_space_groups"                                                                             , &settings->retrieval.IPFP.TXY_group            , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Check and use the time-space groups of \"same parameters in different pixels\" in multipixel inversion"                                                                                                                                                                                                                             , { /*{yamlsettings_validator_mandatory_if_parameter_enum_not,{"retrieval.general.regime_of_multipixel_constraints.inversion_regime","single_pixel"}}*/          },YAMLSETTINGS_END_VAR  },
         {"retrieval.regime_of_multipixel_constraints.time-scale"                                                                                    , &settings->retrieval.IPFP.TTEST                , NULL                                  , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"0.000000e+00"                              }}, {0,{}}                       , YS_PARAM_SCALAR         , "Constraints for restriction of t-variability in multipixel inversion"                                                                                                                                                                                                                                                               , { {yamlsettings_validator_mandatory_if_parameter_true,{"retrieval.regime_of_multipixel_constraints.time_space_groups"}}                                        },YAMLSETTINGS_END_VAR  },
         {"retrieval.regime_of_multipixel_constraints.x-scale"                                                                                       , &settings->retrieval.IPFP.XTEST                , NULL                                  , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"0.000000e+00"                              }}, {0,{}}                       , YS_PARAM_SCALAR         , "Constraints for restriction of x-variability in multipixel inversion"                                                                                                                                                                                                                                                               , { {yamlsettings_validator_mandatory_if_parameter_true,{"retrieval.regime_of_multipixel_constraints.time_space_groups"}}                                        },YAMLSETTINGS_END_VAR  },
         {"retrieval.regime_of_multipixel_constraints.y-scale"                                                                                       , &settings->retrieval.IPFP.YTEST                , NULL                                  , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"0.000000e+00"                              }}, {0,{}}                       , YS_PARAM_SCALAR         , "Constraints for restriction of y-variability in multipixel inversion"                                                                                                                                                                                                                                                               , { {yamlsettings_validator_mandatory_if_parameter_true,{"retrieval.regime_of_multipixel_constraints.time_space_groups"}}                                        },YAMLSETTINGS_END_VAR  },                  
         {"retrieval.regime_of_measurement_fitting.polarization"                                                                                     , &settings->retrieval.iPOBS                     , NULL                                  , GRASP_DATA_TYPE_PFITTING                                , {ys_d_all,{"absolute_polarization_components"          }}, {0,{}}                       , YS_PARAM_SCALAR         , "1.-We fit: I, Q, U; 2.- We fit: I, Q/I, U/I; 3.- We fit: I, (Q^2+U^2)^(1/2) (Polarized measurements can be defined in input data as Q and U or P); 4- We fit: I, [(Q^2+U^2)^(1/2)]/I (Polarized measurements can be defined in input data as Q and U or P); 5- We fit: P/I (User has to provide P/I in input data)"                 , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.regime_of_measurement_fitting.radiance"                                                                                         , &settings->retrieval.iIOBS                     , NULL                                  , GRASP_DATA_TYPE_IFITTING                                , {ys_d_all,{"radiances"                                 }}, {0,{}}                       , YS_PARAM_SCALAR         , "1.-We fit: I; 2.- We fit I/sum(I(:))"                                                                                                                                                                                                                                                                                               , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.product_configuration.wavelength_indices_for_angstrom"                                                                          , &settings->retrieval.Aexp_iwl                  , &settings->tmp.nAexp_iwl              , YS_DATA_TYPE_INT                                        , {ys_d_all,{"1"                                         }}, {1,{2}}                      , YS_PARAM_ARRAY          , "Indices of wavelengths which will be used to calculate Angstrom exponent"                                                                                                                                                                                                                                                           , {                                          {graspsettings_validator_indexes_of_wavelengths,{"1"}} , {yamlsettings_validator_ascendant_int_array,{}}            },YAMLSETTINGS_END_VAR  },
         {"retrieval.product_configuration.aerosol_particulate_matter_diameter"                                                                      , &settings->retrieval.PM_diam                   , &settings->retrieval.nPM_diam         , YS_DATA_TYPE_FLOAT                                      , {ys_d_array,{"0"  ,"2","0:2.5","1:10"                  }}, {1,{2}}                      , YS_PARAM_OPTIONAL_ARRAY , "Diameters of aerosol particles in microns which will be used to calculate Particulate Matter (PM)"                                                                                                                                                                                                                                  , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.product_configuration.wavelength_indices_for_ndvi"                                                                              , &settings->retrieval.ndvi_iwl                  , &settings->tmp.nndvi_iwl              , YS_DATA_TYPE_INT                                        , {ys_d_all,{"1"                                         }}, {1,{2}}                      , YS_PARAM_ARRAY          , "Indices of wavelengths which will be used to calculate NDVI if it is calculated"                                                                                                                                                                                                                                                    , {                                          {graspsettings_validator_indexes_of_wavelengths,{"1"}} , {yamlsettings_validator_ascendant_int_array,{}}            },YAMLSETTINGS_END_VAR  },
         {"retrieval.phase_matrix.size_binning_method_for_triangle_bins"                                                                             , &settings->retrieval.IBIN                      , NULL                                  , GRASP_DATA_TYPE_BIN                                     , {ys_d_all,{"logarithm"                                 }}, {0,{}}                       , YS_PARAM_SCALAR         , "Determining the scale used for the binning of size distribution"                                                                                                                                                                                                                                                                    , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.phase_matrix.number_of_elements"                                                                                                , &settings->retrieval.DLSF.keyEL                , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "Number of phase matrix elements used in the calculations and retrieval"                                                                                                                                                                                                                                                             , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.phase_matrix.use_models"                                                                                                        , &settings->retrieval.use_models                , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Use GRASP 'models' approach which produce results less acurated (based on models) but the process is much quicker"                                                                                                                                                                                                                  , {                                               {graspsettings_validator_models ,{}}                                                                           },YAMLSETTINGS_END_VAR  },
         {"retrieval.phase_matrix.kernels_folder"                                                                                                    , &settings->retrieval.DLSF.distname_O           , NULL                                  , GRASP_DATA_TYPE_FORTRAN_STRING(_GBL_FILE_PATH_LEN)      , {ys_d_all,{"KERNELS_BASE/"                             }}, {0,{}}                       , YS_PARAM_SCALAR         , "Path to kernels when we retrieve size distribution for triangle bins or lognormal size distribution"                                                                                                                                                                                                                                , {                                               {graspsettings_validator_kernelpath ,{}}                                                                       },YAMLSETTINGS_END_VAR  },
         {"retrieval.phase_matrix.radius.mode[].bins"                                                                                                , &settings->retrieval.RADIUS1                   , settings->retrieval.NBIN              , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"0.000000e+00"                              }}, {2,{_KSD,_KIDIM3}}           , YS_PARAM_ARRAY          , "Number of triangle bins set for size distribution representation"                                                                                                                                                                                                                                                                   , {                                {graspsettings_validator_bins,{}}                                                                                             },YAMLSETTINGS_END_VAR  },
         {"retrieval.phase_matrix.radius.mode[].min"                                                                                                 , &settings->retrieval.RMIN                      , &settings->tmp.NRMIN                  , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"-1"                                        }}, {1,{_KSD}}                   , YS_PARAM_SCALAR         , "Minimum value of the radius used in the triangle bins"                                                                                                                                                                                                                                                                              , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.phase_matrix.radius.mode[].max"                                                                                                 , &settings->retrieval.RMAX                      , &settings->tmp.NRMAX                  , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"-1"                                        }}, {1,{_KSD}}                   , YS_PARAM_SCALAR         , "Maximum value of the radius used in the triangle bins"                                                                                                                                                                                                                                                                              , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.edges_size.x"                                                                                                                   , &settings->retrieval.edges.nx                  , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "Size of edges width in pixels (it have to be lower than KIEDGE compilation constant)"                                                                                                                                                                                                                                               , {  {yamlsettings_validator_int,{"0",CONST2STR(_KIEDGE)}}                                                                                                       },YAMLSETTINGS_END_VAR  },
         {"retrieval.edges_size.y"                                                                                                                   , &settings->retrieval.edges.ny                  , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "Size of edges height in pixels (it have to be lower than KIEDGE compilation constant)"                                                                                                                                                                                                                                              , {  {yamlsettings_validator_int,{"0",CONST2STR(_KIEDGE)}}                                                                                                       },YAMLSETTINGS_END_VAR  },                  
         {"retrieval.edges_size.t"                                                                                                                   , &settings->retrieval.edges.nt                  , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "Size of temporal dimension of edges (it have to be lower than KIEDGE compilation constant)"                                                                                                                                                                                                                                         , {  {yamlsettings_validator_int,{"0",CONST2STR(_KIEDGE)}}                                                                                                       },YAMLSETTINGS_END_VAR  },
         {"retrieval.radiative_transfer.number_of_layers"                                                                                            , &settings->retrieval.NLYRS                     , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "Maximum number of vertical layers resolved in radiative transfer"                                                                                                                                                                                                                                                                   , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },         
         {"retrieval.radiative_transfer.molecular_profile_vertical_type"                                                                             , &settings->retrieval.mol_prof_type             , NULL                                  , GRASP_DATA_TYPE_MOL_PROF_VERT_TYPE                      , {ys_d_all,{"exponential"                               }}, {0,{}}                       , YS_PARAM_SCALAR         , "It defines which model will be used to describe vertical profile of molecular (Rayleigh) scattering. Values: 'Exponential' describes molecular density profile at altitude h as exp(h/8)/8, 'Standard_atmosphere' uses standard atmosphere model (pressure and temperature profiles) to calculate molecular density at each altitude." , {                                                                                                                                                           },YAMLSETTINGS_END_VAR  },
         {"retrieval.radiative_transfer.aerosol_profile_vertical_type"                                                                               , &settings->retrieval.aer_prof_type             , NULL                                  , GRASP_DATA_TYPE_AER_PROF_VERT_TYPE                      , {ys_d_all,{"gaussian"                                  }}, {0,{}}                       , YS_PARAM_SCALAR         , "It defines which model will be used to describe vertical profile of aerosol distribution. Values: 'Exponential' describes aerosol concentration profile at altitude h as exp(h/HM)/HM, 'gaussian' uses normal distribution exp(h-HM)/(sqrt(rpi)*sqrt(2.)*sigma) with sigma and HM parameter taken from parameters."                 , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.radiative_transfer.phase_matrix_truncation"                                                                                     , &settings->retrieval.ITRONC                    , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"true"                                      }}, {0,{}}                       , YS_PARAM_SCALAR         , "Switch on/off the truncation: the technique to calculate scattering effects from the sharp forward peak of the phase function separately from those of the rest of the phase function. It doesn't effect considerably the accuracy while provides much faster calculations"                                                         , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },         
         {"retrieval.radiative_transfer.absolute_error_rt_calculations"                                                                              , &settings->retrieval.eps_err                   , NULL                                  , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"0.0001"                                    }}, {0,{}}                       , YS_PARAM_SCALAR         , "Absolute value of truncation threshold of Fourier and order-of-scattering series expansions in radiative transfer calculations"                                                                                                                                                                                                     , {                                           {yamlsettings_validator_float,{"1e-6","1e-3"}}                                                                     },YAMLSETTINGS_END_VAR  },         
         {"retrieval.radiative_transfer.reference_plane_for_polarization"                                                                            , &settings->retrieval.ipplane                   , NULL                                  , GRASP_DATA_TYPE_IPPLANE                                 , {ys_d_all,{"principal_plane"                           }}, {0,{}}                       , YS_PARAM_SCALAR         , "Reference plane for polarization calculations"                                                                                                                                                                                                                                                                                      , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.radiative_transfer.simulating_observation.order_of_scattering"                                                                  , &settings->retrieval.OSHF.IMSC                 , NULL                                  , GRASP_DATA_TYPE_IMSC                                    , {ys_d_all,{"multiple_scattering"                       }}, {0,{}}                       , YS_PARAM_SCALAR         , "Regime of scattering used for modeling diffuse radiation observations"                                                                                                                                                                                                                                                              , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },     
         {"retrieval.radiative_transfer.simulating_observation.number_of_gaussian_quadratures_for_expansion_coefficients"                            , &settings->retrieval.OSHF.NG                   , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "Number of Gaussian quadratures for calculating expansion coefficients used for multiple scattering simulations"                                                                                                                                                                                                                     , {                                           {yamlsettings_validator_int,{"0",CONST2STR(_NG0)}}                                                                 },YAMLSETTINGS_END_VAR  },     
         {"retrieval.radiative_transfer.simulating_observation.number_of_guassian_quadratures_for_fourier_expansion_coefficients"                    , &settings->retrieval.OSHF.NN                   , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "Number of Gaussian quadratures for calculating Fourier expansion coefficients used for multiple scattering simulations"                                                                                                                                                                                                             , {                                           {yamlsettings_validator_int,{"0",CONST2STR(_NN0)}}                                                                 },YAMLSETTINGS_END_VAR  },     
         {"retrieval.radiative_transfer.simulating_observation.number_of_fourier_expansion_coefficients"                                             , &settings->retrieval.OSHF.NF                   , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "Number of Fourier expansion coefficients used in multiple scattering simulations"                                                                                                                                                                                                                                                   , {                                           {yamlsettings_validator_int,{"0",CONST2STR(_NN0)}}                                                                 },YAMLSETTINGS_END_VAR  },
         {"retrieval.radiative_transfer.simulating_derivatives.order_of_scattering"                                                                  , &settings->retrieval.OSHD.IMSC                 , NULL                                  , GRASP_DATA_TYPE_IMSC                                    , {ys_d_all,{"single_scattering"                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "Regime of scattering used in calculation of radiance derivatives"                                                                                                                                                                                                                                                                   , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },     
         {"retrieval.radiative_transfer.simulating_derivatives.number_of_gaussian_quadratures_for_expansion_coefficients"                            , &settings->retrieval.OSHD.NG                   , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "Number of Gaussian quadratures for calculating expansion coefficients used in calculation of radiance derivatives"                                                                                                                                                                                                                  , {                                           {yamlsettings_validator_int,{"0",CONST2STR(_NG0)}}                                                                 },YAMLSETTINGS_END_VAR  },     
         {"retrieval.radiative_transfer.simulating_derivatives.number_of_guassian_quadratures_for_fourier_expansion_coefficients"                    , &settings->retrieval.OSHD.NN                   , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "Number of Gaussian quadratures used for calculating Fourier expansion coefficients used in calculation of radiance derivatives"                                                                                                                                                                                                     , {                                           {yamlsettings_validator_int,{"0",CONST2STR(_NN0)}}                                                                 },YAMLSETTINGS_END_VAR  },     
         {"retrieval.radiative_transfer.simulating_derivatives.number_of_fourier_expansion_coefficients"                                             , &settings->retrieval.OSHD.NF                   , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "Number of Fourier expansion coefficients used in calculation of radiance derivatives"                                                                                                                                                                                                                                               , {                                           {yamlsettings_validator_int,{"0",CONST2STR(_NN0)}}                                                                 },YAMLSETTINGS_END_VAR  },        
         {"retrieval.noises.noise[].standard_deviation_synthetic"                                                                                    , &settings->retrieval.NOISE.SGMS                , &settings->tmp.NOISE_ISGMS             , YS_DATA_TYPE_FLOAT                                     , {ys_d_all,{"0.000000e+00"                              }}, {1,{_KKNOISE}}               , YS_PARAM_SCALAR         , "Standard deviation of synthetic random noise added to the corresponding inverted data, if value is 0 no synthetic random noise is added"                                                                                                                                                                                            , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.noises.noise[].error_type"                                                                                                      , &settings->retrieval.NOISE.INN                 , &settings->retrieval.NOISE.INOISE     , GRASP_DATA_TYPE_ERROR                                   , {ys_d_all,{"absolute"                                  }}, {1,{_KKNOISE}}               , YS_PARAM_SCALAR         , "Error type used for definition of covariance matrices used in measurement fitting and in modeling synthetic noise"                                                                                                                                                                                                                  , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.noises.noise[].standard_deviation"                                                                                              , &settings->retrieval.NOISE.DNN                 , &settings->tmp.NOISE_IDNN             , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"0.000000e+00"                              }}, {1,{_KKNOISE}}               , YS_PARAM_SCALAR         , "Standard deviation of the random noise expected (this defines the covariance matrix used in fitting)"                                                                                                                                                                                                                               , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.noises.noise[].measurement_type[].type"                                                                                         , &settings->retrieval.NOISE.MT                  , settings->retrieval.NOISE.NMT         , GRASP_DATA_TYPE_MEASURETYPES                            , {ys_d_all,{"tod"                                       }}, {2,{_KKNOISE,_KIP}}          , YS_PARAM_SCALAR         , "Type of relevant measurements for applying the noise assumptions"                                                                                                                                                                                                                                                                   , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },         
         {"retrieval.noises.noise[].measurement_type[].index_of_wavelength_involved"                                                                 , &settings->retrieval.NOISE.IWLP                , (int *)settings->retrieval.NOISE.NWLP , YS_DATA_TYPE_INT                                        , {ys_d_all,{"1"                                         }}, {3,{_KKNOISE,_KIP,_KWM}}     , YS_PARAM_ARRAY          , "List of indices of relevant wavelengths for applying the noise assumptions"                                                                                                                                                                                                                                                         , {                                            {graspsettings_validator_indexes_of_wavelengths,{""}}                                                             },YAMLSETTINGS_END_VAR  },         
         {"retrieval.products.aerosol.chemistry"                                                                                                     , &settings->retrieval.products.aerosol.chem     , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Retrieve aerosol chemical composition (if retrieved)"                                                                                                                                                                                                                                                                               , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.aerosol.lidar"                                                                                                         , &settings->retrieval.products.aerosol.lidar    , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Retrieve columnar lidar ratios (e.g., if lidar data are inverted)"                                                                                                                                                                                                                                                                  , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.aerosol.optical_properties"                                                                                            , &settings->retrieval.products.aerosol.opt      , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"true"                                      }}, {0,{}}                       , YS_PARAM_SCALAR         , "Provide aerosol optical properties"                                                                                                                                                                                                                                                                                                 , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.aerosol.phase_matrix"                                                                                                  , &settings->retrieval.products.aerosol.phmx     , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Obtain aerosol phase matrix"                                                                                                                                                                                                                                                                                                        , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.aerosol.refractive_index"                                                                                              , &settings->retrieval.products.aerosol.rind     , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"true"                                      }}, {0,{}}                       , YS_PARAM_SCALAR         , "Provide aerosol refractive index"                                                                                                                                                                                                                                                                                                   , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.aerosol.theoretical_bimodal_extinction"                                                                                , &settings->retrieval.products.aerosol.sd2m_ext , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Provide estimated aerosol extinction for fine and coarse modes"                                                                                                                                                                                                                                                                     , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.aerosol.theoretical_bimodal_parameters"                                                                                , &settings->retrieval.products.aerosol.sd2m_mph , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Provide estimated aerosol microphysical characteristics for fine and coarse modes"                                                                                                                                                                                                                                                  , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.aerosol.particulate_matter"                                                                                            , &settings->retrieval.products.aerosol.pm       , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Obtain aerosol particulate matter estimation at given particle diameters"                                                                                                                                                                                                                                                           , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.aerosol.type"                                                                                                          , &settings->retrieval.products.aerosol.types    , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Obtain aerosol type index i.e. 0-Complex mixture,1-Background,2-Maritime,3-Urbn.Polluted,4-Mixed,5-Urbn.clean,6-Smoke flam.,7-Smoke. sold.,8-Dust"                                                                                                                                                                                  , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.clouds.chemistry"                                                                                                      , &settings->retrieval.products.clouds.chem      , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Retrieve cloud composition"                                                                                                                                                                                                                                                                                                         , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.clouds.lidar"                                                                                                          , &settings->retrieval.products.clouds.lidar     , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Retrieve cloud vertical profiles (e.g., if lidar or radar data are inverted)"                                                                                                                                                                                                                                                       , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.clouds.optical_properties"                                                                                             , &settings->retrieval.products.clouds.opt       , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Retrieve cloud optical properties"                                                                                                                                                                                                                                                                                                  , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.clouds.phase_matrix"                                                                                                   , &settings->retrieval.products.clouds.phmx      , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Obtain cloud phase matrix"                                                                                                                                                                                                                                                                                                          , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.clouds.refractive_index"                                                                                               , &settings->retrieval.products.clouds.rind      , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Retrieve cloud refractive index"                                                                                                                                                                                                                                                                                                    , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.clouds.theoretical_bimodal_extinction"                                                                                 , &settings->retrieval.products.clouds.sd2m_ext  , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Retrieve estimated cloud extinction for fine and coarse modes"                                                                                                                                                                                                                                                                      , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.clouds.theoretical_bimodal_parameters"                                                                                 , &settings->retrieval.products.clouds.sd2m_mph  , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Retrieve estimated cloud microphysical characteristics for fine and coarse modes"                                                                                                                                                                                                                                                   , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },                                                                                                                                                                                                            
         {"retrieval.products.clouds.particulate_matter"                                                                                             , &settings->retrieval.products.clouds.pm        , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Obtain cloud particulate matter estimation at given particle diameters"                                                                                                                                                                                                                                                             , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.cloud.type"                                                                                                            , &settings->retrieval.products.clouds.types     , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Obtain cloud type index"                                                                                                                                                                                                                                                                                                            , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.error_estimation.aerosol.lidar"                                                                                        , &settings->retrieval.products.errest.aerosol.lidar, NULL                               , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Implement error estimation for aerosol lidar products"                                                                                                                                                                                                                                                                              , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.error_estimation.aerosol.optical_properties"                                                                           , &settings->retrieval.products.errest.aerosol.opt  , NULL                               , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Implement error estimation for optical properties of aerosol products"                                                                                                                                                                                                                                                              , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.error_estimation.clouds.lidar"                                                                                         , &settings->retrieval.products.errest.clouds.lidar , NULL                               , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Implement error estimation for aerosol lidar products"                                                                                                                                                                                                                                                                              , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.error_estimation.clouds.optical_properties"                                                                            , &settings->retrieval.products.errest.clouds.opt   , NULL                               , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Implement error estimation for optical properties of aerosol products"                                                                                                                                                                                                                                                              , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.error_estimation.parameters"                                                                                           , &settings->retrieval.products.errest.par          , NULL                               , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Implement error estimation for retrieved parameters"                                                                                                                                                                                                                                                                                , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },                                                                                                                                                                                                            
         {"retrieval.products.forcing.broadband_flux"                                                                                                , &settings->retrieval.products.forcing.bbflux   , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Provide upward and downward fluxes integrated over the solar spectrum at the user-defined levels for the scenarios with and without aerosols"                                                                                                                                                                                       , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.forcing.forcing"                                                                                                       , &settings->retrieval.products.forcing.forcing  , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Provide aerosol radiative forcing values at the user-defined levels"                                                                                                                                                                                                                                                                , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },                                                                                                                                                                                                                           
         {"retrieval.products.retrieval.fitting"                                                                                                     , &settings->retrieval.products.retrieval.fit    , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Provide obtained measurement fitting"                                                                                                                                                                                                                                                                                               , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.retrieval.parameters"                                                                                                  , &settings->retrieval.products.retrieval.par    , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"true"                                      }}, {0,{}}                       , YS_PARAM_SCALAR         , "Provide retrieved parameters"                                                                                                                                                                                                                                                                                                       , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.retrieval.residual"                                                                                                    , &settings->retrieval.products.retrieval.res    , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"true"                                      }}, {0,{}}                       , YS_PARAM_SCALAR         , "Provide values of obtained residuals"                                                                                                                                                                                                                                                                                               , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.products.surface"                                                                                                               , &settings->retrieval.products.surface.surf     , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Provide surface reflectance products"                                                                                                                                                                                                                                                                                               , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },                  
         {"retrieval.debug.verbose"                                                                                                                  , &settings->retrieval.IPRI_verbose              , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"true"                                      }}, {0,{}}                       , YS_PARAM_SCALAR         , "Retrieval prints progress information while it is performing the inversion"                                                                                                                                                                                                                                                         , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.debug.additional_information"                                                                                                   , &settings->retrieval.IPRI_additional_info      , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Print some additional information"                                                                                                                                                                                                                                                                                                  , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.debug.iteration_information"                                                                                                    , &settings->retrieval.IPRI_iter_result          , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "If it is true it prints retrieval information after each iteration (Only in multipixel scenario)"                                                                                                                                                                                                                                   , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },                  
         {"retrieval.debug.simulated_sdata_file"                                                                                                     , &settings->retrieval.sdata_sim_file            , NULL                                  , GRASP_DATA_TYPE_FORTRAN_FILE_PATH(_GBL_FILE_PATH_LEN)   , {ys_d_all,{""                                          }}, {0,{}}                       , YS_PARAM_SCALAR         , "Filename where simulated observation data are to be printed. This option force retrieval.general.stop_before_performing_retrieval=true"                                                                                                                                                                                             , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },                                                  
         {"retrieval.debug.path_to_extra_files"                                                                                                      , &settings->retrieval.DLSF.external_file_path   , NULL                                  , GRASP_DATA_TYPE_FORTRAN_FOLDER_PATH(_GBL_FILE_PATH_LEN) , {ys_d_all,{"/tmp/"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Path to folder with retrieval extra files: debug information, extra resources like image.dat files..."                                                                                                                                                                                                                              , {                                            {grasp_settings_validator_directory_fortran , {           }  }                                                    },YAMLSETTINGS_END_VAR  },                  
         {"retrieval.debug.use_internal_initial_guess"                                                                                               , &settings->retrieval.INPUT                     , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Test option which allows to load different initial guess for each pixel (loading them from image.dat files)"                                                                                                                                                                                                                        , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },                  
         {"retrieval.constraints.characteristic[].type"                                                                                              , &settings->retrieval.NDIM.par_type             , &settings->tmp.NDIM_npar_type         , GRASP_DATA_TYPE_CHARACTERISTIC                          , {ys_d_all,{"size_distribution_triangle_bins"           }}, {1,{_KIDIM1}}                , YS_PARAM_SCALAR         , "Type of characteristic"                                                                                                                                                                                                                                                                                                             , {  {yamlsettings_validator_mandatory,{}} , {graspsettings_validator_characteristic_type,{}}                                                                    },YAMLSETTINGS_END_VAR  },
         {"retrieval.constraints.characteristic[].retrieved"                                                                                         , &settings->retrieval.NDIM.par_retr             , &settings->tmp.NDIM_npar_retr         , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"true"                                      }}, {1,{_KIDIM1}}                , YS_PARAM_SCALAR         , "Specify if this characteristic will be retrieved or only used in forward model"                                                                                                                                                                                                                                                     , {                                         {graspsettings_validator_characteristic_retrieved,{}}                                                                },YAMLSETTINGS_END_VAR  },
         {"retrieval.constraints.characteristic[].mode[].initial_guess.value"                                                                        , &settings->tmp.TAPSING                         , (int *)settings->tmp.NTAPSING         , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{CONST2STR(FLT_MIN)                          }}, {3,{_KIDIM1,_KIDIM2,_KPARS}} , YS_PARAM_OPTIONAL_ARRAY , "Initial values for a specific (determined by type) characteristic"                                                                                                                                                                                                                                                                  , {  {yamlsettings_validator_float,{CONST2STR(FLT_MIN),CONST2STR(INFINITE)}}                                                                                     },YAMLSETTINGS_END_VAR  },
         {"retrieval.constraints.characteristic[].mode[].initial_guess.min"                                                                          , &settings->tmp.TAPSMIN                         , (int *)settings->tmp.NTAPSMIN         , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"0.000000e+00"                              }}, {3,{_KIDIM1,_KIDIM2,_KPARS}} , YS_PARAM_OPTIONAL_ARRAY , "Minimum value for the specific characteristic"                                                                                                                                                                                                                                                                                      , {  {yamlsettings_validator_same_nelements,{"retrieval.constraints.characteristic[].mode[].initial_guess.value"}}                                               },YAMLSETTINGS_END_VAR  },        
         {"retrieval.constraints.characteristic[].mode[].initial_guess.max"                                                                          , &settings->tmp.TAPSMAX                         , (int *)settings->tmp.NTAPSMAX         , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"0.000000e+00"                              }}, {3,{_KIDIM1,_KIDIM2,_KPARS}} , YS_PARAM_OPTIONAL_ARRAY , "Maximum value for the specific characteristic"                                                                                                                                                                                                                                                                                      , {  {yamlsettings_validator_same_nelements,{"retrieval.constraints.characteristic[].mode[].initial_guess.value"}}                                               },YAMLSETTINGS_END_VAR  },        
         {"retrieval.constraints.characteristic[].mode[].initial_guess.index_of_wavelength_involved"                                                 , &settings->tmp.TIWW_SINGL                      , (int *)settings->tmp.NTIWW_SINGL      , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {3,{_KIDIM1,_KIDIM2,_KPARS}} , YS_PARAM_OPTIONAL_ARRAY , "Indices of Wavelengths associated to the specific characteristic"                                                                                                                                                                                                                                                                   , {{yamlsettings_validator_same_nelements,{"retrieval.constraints.characteristic[].mode[].initial_guess.value"}},{yamlsettings_validator_int,{"0",CONST2STR(_KW)}}},YAMLSETTINGS_END_VAR  },        
         {"retrieval.constraints.characteristic[].mode[].single_pixel.a_priori_estimates.lagrange_multiplier"                                        , &settings->retrieval.SPCA.GSM                  , (int *)settings->tmp.SPCA_IGSM        , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"0.000000e+00"                              }}, {3,{_KIDIM1,_KIDIM2,_KIDIM3}}, YS_PARAM_ARRAY          , "Value of the Lagrange multiplier associated to a priori estimate of the retrieved characteristics (applied in each single pixel)"                                                                                                                                                                                                   , {  {graspsettings_validator_same_nelements_or_zero,{"retrieval.constraints.characteristic[].mode[].initial_guess.value"}}                                      },YAMLSETTINGS_END_VAR  },
         {"retrieval.constraints.characteristic[].mode[].single_pixel.smoothness_constraints.difference_order"                                       , &settings->retrieval.SPCS.IO                   , settings->tmp.SPCS_IIO                , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {2,{_KIDIM1,_KIDIM2}}        , YS_PARAM_SCALAR         , "Order of the derivatives/differences  used for applying a priori smoothness constrains for the retrieved characteristics"                                                                                                                                                                                                           , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.constraints.characteristic[].mode[].single_pixel.smoothness_constraints.lagrange_multiplier"                                    , &settings->retrieval.SPCS.GSM                  , settings->tmp.SPCS_IGSM               , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"0.000000e+00"                              }}, {2,{_KIDIM1,_KIDIM2}}        , YS_PARAM_SCALAR         , "Value of the Lagrange multiplayer used for applying a priori smoothness constraints for the retrieved characteristics"                                                                                                                                                                                                              , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.constraints.characteristic[].mode[].multi_pixel.smoothness_constraints.derivative_order_of_X_variability"                       , &settings->retrieval.MPCS.IOX                  , settings->tmp.MPCS_IIOX               , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {2,{_KIDIM1,_KIDIM2}}        , YS_PARAM_SCALAR         , "Order of derivatives/differences  used for applying a priori smoothness constraints on parameter inter-pixel X-variability in multi-pixel retrieval regime"                                                                                                                                                                         , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.constraints.characteristic[].mode[].multi_pixel.smoothness_constraints.lagrange_multiplier_of_X_variability"                    , &settings->retrieval.MPCS.GSMX                 , settings->tmp.MPCS_IGSMX              , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"0.000000e+00"                              }}, {2,{_KIDIM1,_KIDIM2}}        , YS_PARAM_SCALAR         , "Value of the Lagrange multiplier used for applying a priori smoothness constraints on parameter inter-pixel X-variability in multi-pixel retrieval regime"                                                                                                                                                                          , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },               
         {"retrieval.constraints.characteristic[].mode[].multi_pixel.smoothness_constraints.derivative_order_of_Y_variability"                       , &settings->retrieval.MPCS.IOY                  , settings->tmp.MPCS_IIOY               , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {2,{_KIDIM1,_KIDIM2}}        , YS_PARAM_SCALAR         , "Order of derivatives/differences  used for applying a priori smoothness constraints on parameter inter-pixel Y-variability in multi-pixel retrieval regime"                                                                                                                                                                         , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.constraints.characteristic[].mode[].multi_pixel.smoothness_constraints.lagrange_multiplier_of_Y_variability"                    , &settings->retrieval.MPCS.GSMY                 , settings->tmp.MPCS_IGSMY              , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"0.000000e+00"                              }}, {2,{_KIDIM1,_KIDIM2}}        , YS_PARAM_SCALAR         , "Value of the Lagrange multiplier used for applying a priori smoothness constraints on parameter inter-pixel Y-variability in multi-pixel retrieval regime"                                                                                                                                                                          , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },                
         {"retrieval.constraints.characteristic[].mode[].multi_pixel.smoothness_constraints.derivative_order_of_T_variability"                       , &settings->retrieval.MPCS.IOT                  , settings->tmp.MPCS_IIOT               , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {2,{_KIDIM1,_KIDIM2}}        , YS_PARAM_SCALAR         , "Order of derivatives/differences  used for applying a priori smoothness constraints on parameter inter-pixel T-variability in multi-pixel retrieval regime"                                                                                                                                                                         , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"retrieval.constraints.characteristic[].mode[].multi_pixel.smoothness_constraints.lagrange_multiplier_of_T_variability"                    , &settings->retrieval.MPCS.GSMT                 , settings->tmp.MPCS_IGSMT              , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"0.000000e+00"                              }}, {2,{_KIDIM1,_KIDIM2}}        , YS_PARAM_SCALAR         , "Value of the Lagrange multiplier used for applying a priori smoothness constraints on parameter inter-pixel T-variability in multi-pixel retrieval regime"                                                                                                                                                                          , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },                   
         {"retrieval.untested.ratio[].value"                                                                                                         , &settings->retrieval.RATIO1                    , settings->tmp.NRATIO1                 , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"1.000000e+00"                              }}, {2,{_KIDIM3,_KSD}}           , YS_PARAM_ARRAY          , "Values of bins using in retrieved aspect or axis distributions"                                                                                                                                                                                                                                                                     , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
    };
    
    yamlsettings_parameter settings_settings[]= {
         {"settings.debug"                                                                                                                           , &settings->settings.debug                      , NULL                                  , YS_DATA_TYPE_STRING(_GBL_FILE_PATH_LEN)                 , {ys_d_all,{"."                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "Shows settings read to run this program"                                                                                                                                                                                                                                                                                            , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"settings.strict"                                                                                                                          , &settings->settings.strict                     , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"true"                                      }}, {0,{}}                       , YS_PARAM_SCALAR         , "Force GRASP to continue when there were parse or validation errors in the settings file"                                                                                                                                                                                                                                            , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },         
         {"settings.dump"                                                                                                                            , &settings->settings.short_dump                 , NULL                                  , GRASP_DATA_TYPE_STREAM(_GBL_FILE_PATH_LEN)              , {ys_d_all,{"none"                                      }}, {0,{}}                       , YS_PARAM_SCALAR         , "Stream to dump read settings in short format(experimental)"                                                                                                                                                                                                                                                                         , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },         
         {"settings.long_dump"                                                                                                                       , &settings->settings.long_dump                  , NULL                                  , GRASP_DATA_TYPE_STREAM(_GBL_FILE_PATH_LEN)              , {ys_d_all,{"none"                                      }}, {0,{}}                       , YS_PARAM_SCALAR         , "Stream to dump read settings in long format (experimental)"                                                                                                                                                                                                                                                                         , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },         
    };
    yamlsettings_parameter settings_input[]= {
         {"input.driver"                                                                                                                             , &settings->input.driver_name                   , NULL                                  , YS_DATA_TYPE_STRING(_GBL_FILE_PATH_LEN)                 , {ys_d_all,{"sdata_driver"                              }}, {0,{}}                       , YS_PARAM_SCALAR         , "The driver that will be called for inverting data"                                                                                                                                                                                                                                                                                  , {  {yamlsettings_validator_mandatory,{}}           , {grasp_settings_validator_input_driver,{}}                                                                },YAMLSETTINGS_END_VAR  },
         {"input.file"                                                                                                                               , &settings->input.files                         , &settings->input.nfiles               , YS_DATA_TYPE_FILE_PATH(_GBL_FILE_PATH_LEN)              , {ys_d_all,{""                                          }}, {1,{GRASP_INPUT_MAX_FILES}}  , YS_PARAM_OPTIONAL_ARRAY , "Name of file(s) which contain input observation"                                                                                                                                                                                                                                                                                    , {  {yamlsettings_validator_mandatory,{}}                                                                                                                       },YAMLSETTINGS_END_VAR  },
         {"input.center.latitude"                                                                                                                    , &settings->input.coordinates.lat               , NULL                                  , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"0.000000e+00"                              }}, {0,{}}                       , YS_PARAM_SCALAR         , "Latitude of the center of tile to invert"                                                                                                                                                                                                                                                                                           , {  {yamlsettings_validator_float ,{"-90.0","90.0"}}                                                                                                            },YAMLSETTINGS_END_VAR  },
         {"input.center.longitude"                                                                                                                   , &settings->input.coordinates.lon               , NULL                                  , YS_DATA_TYPE_FLOAT                                      , {ys_d_all,{"0.000000e+00"                              }}, {0,{}}                       , YS_PARAM_SCALAR         , "Latitude of the center of tile to invert"                                                                                                                                                                                                                                                                                           , {  {yamlsettings_validator_float ,{"-180.0","180.0"}}                                                                                                          },YAMLSETTINGS_END_VAR  },
         {"input.corner.row"                                                                                                                         , &settings->input.coordinates_grid.row          , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"-1"                                        }}, {0,{}}                       , YS_PARAM_SCALAR         , "The number of the row for input driver in the native coordinate system of the sensor"                                                                                                                                                                                                                                               , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"input.corner.column"                                                                                                                      , &settings->input.coordinates_grid.col          , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"-1"                                        }}, {0,{}}                       , YS_PARAM_SCALAR         , "The number of the column for input driver in the native coordinate system of the sensor"                                                                                                                                                                                                                                            , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"input.grid_offset.row"                                                                                                                    , &settings->input.grid_offset.row               , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "Information of the first row in the input grid that will be use for normalizing the output. If 0 is used the output coordinate reference will be the same than the input. This offset is for forcing the output row to start at 0 (e.g. if you put 1, output_row == input_row - 1)"                                                 , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"input.grid_offset.column"                                                                                                                 , &settings->input.grid_offset.col               , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "Information of the first column in the input grid that will be used for normalizing the output. If 0 is used the output coordinate reference will be the same than the input. This offset is for forcing the output column to start at 0 (e.g. if you put 1, output_column == input_column - 1)"                                    , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"input.area.width"                                                                                                                         , &settings->input.area_width                    , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"1"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "The width of the covered area in pixels. It has to be divisible by intput.segment.x value"                                                                                                                                                                                                                                          , {              {graspsettings_validator_divisible,{"input.segment.x"}}                                                                                         },YAMLSETTINGS_END_VAR  },
         {"input.area.height"                                                                                                                        , &settings->input.area_height                   , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"1"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "The height of the covered area in pixels. It has to be divisible by intput.segment.y value"                                                                                                                                                                                                                                         , {              {graspsettings_validator_divisible,{"input.segment.y"}}                                                                                         },YAMLSETTINGS_END_VAR  },
         {"input.time.from"                                                                                                                          , &settings->input.time_from                     , NULL                                  , YS_DATA_TYPE_STRING(_GBL_FILE_PATH_LEN)                 , {ys_d_all,{""                                          }}, {0,{}}                       , YS_PARAM_SCALAR         , "Initial date and time for data processing"                                                                                                                                                                                                                                                                                          , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },
         {"input.time.to"                                                                                                                            , &settings->input.time_to                       , NULL                                  , YS_DATA_TYPE_STRING(_GBL_FILE_PATH_LEN)                 , {ys_d_all,{""                                          }}, {0,{}}                       , YS_PARAM_SCALAR         , "Final date and time for data processing"                                                                                                                                                                                                                                                                                            , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },         
         {"input.segment.x"                                                                                                                          , &settings->input.segment_nx                    , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{CONST2STR(_KIX)                             }}, {0,{}}                       , YS_PARAM_SCALAR         , "Size of segment width in pixels (it have to be lower than KIX compilation constant)"                                                                                                                                                                                                                                                , {  {yamlsettings_validator_int,{"1",CONST2STR(_KIX)}}                                                                                                          },YAMLSETTINGS_END_VAR  },
         {"input.segment.y"                                                                                                                          , &settings->input.segment_ny                    , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{CONST2STR(_KIY)                             }}, {0,{}}                       , YS_PARAM_SCALAR         , "Size of segment height in pixels (it have to be lower than KIY compilation constant)"                                                                                                                                                                                                                                               , {  {yamlsettings_validator_int,{"1",CONST2STR(_KIY)}}                                                                                                          },YAMLSETTINGS_END_VAR  },                  
         {"input.segment.t"                                                                                                                          , &settings->input.segment_nt                    , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{CONST2STR(_KITIME)                          }}, {0,{}}                       , YS_PARAM_SCALAR         , "Size of segment temporal dimension (it have to be lower than KITIME compilation constant)"                                                                                                                                                                                                                                          , {  {yamlsettings_validator_int,{"1",CONST2STR(_KITIME)}}                                                                                                       },YAMLSETTINGS_END_VAR  },                  
         {"input.transformer"                                                                                                                        , &settings->input.transformers_name             , &settings->input.ntransformers        , YS_DATA_TYPE_STRING(_GBL_FILE_PATH_LEN)                 , {ys_d_all,{"none"                                      }}, {1,{GRASP_INPUT_MAX_TRANSFORMERS}}, YS_PARAM_OPTIONAL_ARRAY, "Name of input data transformer functions to be used after load data"                                                                                                                                                                                                                                                            , {                                                  {grasp_settings_validator_input_transformer,{}}                                                             },YAMLSETTINGS_END_VAR  },        
         {"input.debug.raw_segment"                                                                                                                  , &settings->input.print_raw_segment             , NULL                                  , GRASP_DATA_TYPE_STREAM(_GBL_FILE_PATH_LEN)              , {ys_d_all,{"none"                                      }}, {0,{}}                       , YS_PARAM_SCALAR         , "Stream to print raw segment data loaded"                                                                                                                                                                                                                                                                                            , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },         
         {"input.debug.clean_segment"                                                                                                                , &settings->input.print_clean_segment           , NULL                                  , GRASP_DATA_TYPE_STREAM(_GBL_FILE_PATH_LEN)              , {ys_d_all,{"none"                                      }}, {0,{}}                       , YS_PARAM_SCALAR         , "Stream to print segment information after clean NaN values"                                                                                                                                                                                                                                                                         , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },         
         {"input.debug.used_files"                                                                                                                   , &settings->input.print_used_files              , NULL                                  , GRASP_DATA_TYPE_STREAM(_GBL_FILE_PATH_LEN)              , {ys_d_all,{"none"                                      }}, {0,{}}                       , YS_PARAM_SCALAR         , "Stream to print names of the files that have the pixels for inverting"                                                                                                                                                                                                                                                              , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },                  
         {"input.sdata.dump"                                                                                                                         , &settings->input.sdata_stream                  , NULL                                  , GRASP_DATA_TYPE_STREAM(_GBL_FILE_PATH_LEN)              , {ys_d_all,{"none"                                      }}, {0,{}}                       , YS_PARAM_SCALAR         , "Stream where to dump sdata information"                                                                                                                                                                                                                                                                                             , {                                            {grasp_settings_validator_stream   , {           }  }                                                             },YAMLSETTINGS_END_VAR  },         
         {"input.imagedat.dump"                                                                                                                      , &settings->input.imagedat_stream               , NULL                                  , GRASP_DATA_TYPE_STREAM(_GBL_FILE_PATH_LEN)              , {ys_d_all,{"none"                                      }}, {0,{}}                       , YS_PARAM_SCALAR         , "Stream where to dump initial guess information (image.dat format)"                                                                                                                                                                                                                                                                  , {                                            {grasp_settings_validator_stream   , {           }  }                                                             },YAMLSETTINGS_END_VAR  },         
         {"input.preload_segment.x"                                                                                                                  , &settings->input.preload_nsegmentx             , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "This parameter specifies how many segments in X dimension will be preloaded in each block"                                                                                                                                                                                                                                          , {  {yamlsettings_validator_int,{"0",CONST2STR(_KIX)}}                                                                                                          },YAMLSETTINGS_END_VAR  },
         {"input.preload_segment.y"                                                                                                                  , &settings->input.preload_nsegmenty             , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "This parameter specifies how many segments in Y dimension will be preloaded in each block"                                                                                                                                                                                                                                          , {  {yamlsettings_validator_int,{"0",CONST2STR(_KIX)}}                                                                                                          },YAMLSETTINGS_END_VAR  },
         {"input.preload_segment.t"                                                                                                                  , &settings->input.preload_nsegmentt             , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "This parameter specifies how many segments in T dimension will be preloaded in each block"                                                                                                                                                                                                                                          , {  {yamlsettings_validator_int,{"0",CONST2STR(_KIX)}}                                                                                                          },YAMLSETTINGS_END_VAR  },
    };
    yamlsettings_parameter settings_output[]= {
         {"output.segment.function"                                                                                                                  , &settings->output.segment_output_function      , &settings->output.nsegment_output_function, YS_DATA_TYPE_STRING(_GBL_FILE_PATH_LEN)             , {ys_d_all,{"classic"                                   }}, {1,{GRASP_MAX_OUTPUT_FUNC}}  , YS_PARAM_OPTIONAL_ARRAY , "Driver to process output for every single retrieval (show information in screen, perform a map, plotting, ...)"                                                                                                                                                                                                                     , {                                                  {grasp_settings_validator_output_segment_function,{}}                                                       },YAMLSETTINGS_END_VAR  },
         {"output.segment.stream"                                                                                                                    , &settings->output.segment_stream               , &settings->output.nsegment_stream         , GRASP_DATA_TYPE_STREAM(_GBL_FILE_PATH_LEN)          , {ys_d_all,{"screen"                                    }}, {1,{GRASP_MAX_OUTPUT_FUNC}}  , YS_PARAM_OPTIONAL_ARRAY , "Stream to dump segment output data"                                                                                                                                                                                                                                                                                                 , {                                                  {grasp_settings_validator_stream  , {           }  }  ,                                                     },YAMLSETTINGS_END_VAR  },         
         {"output.tile.function"                                                                                                                     , &settings->output.tile_output_function         , &settings->output.ntile_output_function   , YS_DATA_TYPE_STRING(_GBL_FILE_PATH_LEN)             , {ys_d_all,{"none"                                      }}, {1,{GRASP_MAX_OUTPUT_FUNC}}  , YS_PARAM_OPTIONAL_ARRAY , "Driver to process output after processing complete tile (show information in screen, perform a map, plotting, ...)"                                                                                                                                                                                                                 , {                                                  {grasp_settings_validator_output_tile_function,{}}                                                          },YAMLSETTINGS_END_VAR  },                  
         {"output.tile.stream"                                                                                                                       , &settings->output.tile_stream                  , &settings->output.ntile_stream            , GRASP_DATA_TYPE_STREAM(_GBL_FILE_PATH_LEN)          , {ys_d_all,{"screen"                                    }}, {1,{GRASP_MAX_OUTPUT_FUNC}}  , YS_PARAM_OPTIONAL_ARRAY , "Stream to dump tile output data"                                                                                                                                                                                                                                                                                                    , {                                                  {grasp_settings_validator_stream  , {           }  }                                                        },YAMLSETTINGS_END_VAR  },         
         {"output.current.function"                                                                                                                  , &settings->output.current_output_function      , &settings->output.ncurrent_output_function, YS_DATA_TYPE_STRING(_GBL_FILE_PATH_LEN)             , {ys_d_all,{"none"                                      }}, {1,{GRASP_MAX_OUTPUT_FUNC}}  , YS_PARAM_OPTIONAL_ARRAY , "Driver to process output after each retrieval (show information in screen, perform a map, plotting, ...)"                                                                                                                                                                                                                           , {                                                  {grasp_settings_validator_output_current_function,{}}                                                       },YAMLSETTINGS_END_VAR  },
         {"output.current.stream"                                                                                                                    , &settings->output.current_stream               , &settings->output.ncurrent_stream         , GRASP_DATA_TYPE_STREAM(_GBL_FILE_PATH_LEN)          , {ys_d_all,{"screen"                                    }}, {1,{GRASP_MAX_OUTPUT_FUNC}}  , YS_PARAM_OPTIONAL_ARRAY , "Stream to dump current progress information about the retrieval conducted"                                                                                                                                                                                                                                                          , {                                                  {grasp_settings_validator_stream  , {           }  }  ,                                                     },YAMLSETTINGS_END_VAR  },         
    };
    yamlsettings_parameter settings_controller[]= {
         {"controller.segment_range"                                                                                                                 , &settings->controller.segment_range            , &settings->controller.nsegment_range  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"-1"                                        }}, {1,{2}}                      , YS_PARAM_OPTIONAL_ARRAY , "This parameter allows specifying a range of segments that will be inverted/processed. If it is a single number a specific retrieval will be processed. Use -1 as undefined. For example [15, -1] will process all retrievals starting by the segment #15"                                                                           , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },         
         {"controller.debug.perform_retrieval"                                                                                                       , &settings->controller.perform_retrieval        , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"true"                                      }}, {0,{}}                       , YS_PARAM_SCALAR         , "Allowing controller to call retrieval. If this parameter is false the framework will work without inverting the data and it will force to use only none output functions (results will not be printed). This parameter is useful for debug the framework or prepare input data"                                                     , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },                                     
         {"controller.debug.compilation_information"                                                                                                 , &settings->controller.compilation_information  , NULL                                  , YS_DATA_TYPE_BOOLEAN                                    , {ys_d_all,{"false"                                     }}, {0,{}}                       , YS_PARAM_SCALAR         , "Print compilation information at the beginning of the process"                                                                                                                                                                                                                                                                      , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },         
         {"controller.debug.tracking_memory_stream"                                                                                                  , &settings->controller.track_mem_stream         , NULL                                  , GRASP_DATA_TYPE_STREAM(_GBL_FILE_PATH_LEN)              , {ys_d_all,{"none"                                      }}, {0,{}}                       , YS_PARAM_SCALAR         , "Stream where printing all information about memory allocated during the execution (debugging information)"                                                                                                                                                                                                                          , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },         
         {"controller.stream"                                                                                                                        , &settings->controller.stream_pattern           , NULL                                  , GRASP_DATA_TYPE_STREAM(_GBL_FILE_PATH_LEN)              , {ys_d_all,{"screen"                                    }}, {0,{}}                       , YS_PARAM_SCALAR         , "Stream to dump controller information"                                                                                                                                                                                                                                                                                              , {                                            {grasp_settings_validator_stream  , {           }  }                                                              },YAMLSETTINGS_END_VAR  },                  
         {"controller.mpi.maximum_job_time"                                                                                                          , &settings->controller.maximum_job_time         , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"0"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "Maximum number of seconds that the master node will wait for a working node for obtaining results. After this time (specified in seconds) if the job is not finished the controller will kill the task and the segment will be skipped"                                                                                             , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },         
         {"controller.mpi.polling_time"                                                                                                              , &settings->controller.polling_time             , NULL                                  , YS_DATA_TYPE_INT                                        , {ys_d_all,{"1"                                         }}, {0,{}}                       , YS_PARAM_SCALAR         , "Number of seconds that the master node wait after checking the workers"                                                                                                                                                                                                                                                             , {                                                                                                                                                              },YAMLSETTINGS_END_VAR  },         
    }; 
    
   int i,c,idriver, ifunction, itransformer; 
   // Dinamic definition of a dictionary
   yamlsettings_dictionary_t *dictionary;
   // Dictionary for input drivers
   grasp_settings_parameter_array **driver_parameters;
   grasp_settings_parameter_array **transformer_parameters;
   grasp_settings_parameter_array **segment_function_parameters;
   grasp_settings_parameter_array **tile_function_parameters;
   grasp_settings_parameter_array **current_function_parameters;
   
   driver_parameters=grasp_input_driver_get_settings_parameters(settings);
   transformer_parameters=grasp_input_transformer_get_settings_parameters(settings);
   segment_function_parameters=grasp_output_segment_functions_get_settings_parameters(settings);
   tile_function_parameters=grasp_output_tile_functions_get_settings_parameters(settings);
   current_function_parameters=grasp_output_current_functions_get_settings_parameters(settings);
              
   // Create a dictionary and return it
   dictionary=(yamlsettings_dictionary_t *)trackmem_malloc(sizeof(yamlsettings_dictionary_t));   
   assert(dictionary!=NULL);
   
   dictionary->nparameters=
           sizeof(settings_global)/sizeof(yamlsettings_parameter) +
           sizeof(settings_retrieval)/sizeof(yamlsettings_parameter) +
           sizeof(settings_settings)/sizeof(yamlsettings_parameter) +
           sizeof(settings_input)/sizeof(yamlsettings_parameter) +
           sizeof(settings_output)/sizeof(yamlsettings_parameter) +
           sizeof(settings_controller)/sizeof(yamlsettings_parameter) 
           ;
   
   // Calculating input drivers number of parameters
   for (idriver = 0; idriver < grasp_input_ndrivers(); idriver++) {
       if(driver_parameters[idriver]!=NULL){
           dictionary->nparameters+=driver_parameters[idriver]->nparameters;
       }
    }
   // for transformers
   for (itransformer = 0; itransformer < grasp_input_ntransformers(); itransformer++) {
       if(transformer_parameters[itransformer]!=NULL){
           dictionary->nparameters+=transformer_parameters[itransformer]->nparameters;
       }
    }
   
    // Calculating segment function parameters
    for (ifunction = 0; ifunction < grasp_output_segment_nfunctions(); ifunction++) {
        if(segment_function_parameters[ifunction]!=NULL){
            dictionary->nparameters+=segment_function_parameters[ifunction]->nparameters;
        }
    }   
    // Calculating tile function parameters
    for (ifunction = 0; ifunction < grasp_output_tile_nfunctions(); ifunction++) {
        if(tile_function_parameters[ifunction]!=NULL){
            dictionary->nparameters+=tile_function_parameters[ifunction]->nparameters;
        }
    }
    // Calculating current function parameters
    for (ifunction = 0; ifunction < grasp_output_current_nfunctions(); ifunction++) {
        if(current_function_parameters[ifunction]!=NULL){
            dictionary->nparameters+=current_function_parameters[ifunction]->nparameters;
        }
    }   
   
   dictionary->settings=settings;
   dictionary->parameters=(yamlsettings_parameter *)trackmem_malloc(sizeof(yamlsettings_parameter)*(dictionary->nparameters));
   assert(dictionary->parameters!=NULL);
   
   // Copying parameters
   c=0;
   for(i=c;i<sizeof(settings_global)/sizeof(yamlsettings_parameter)+c;i++){
       yamlsettings_copy_parameter(&(settings_global[i-c]),&(dictionary->parameters[i]));
   }
   c=i;
   for(i=c;i<sizeof(settings_retrieval)/sizeof(yamlsettings_parameter)+c;i++){
       yamlsettings_copy_parameter(&(settings_retrieval[i-c]),&(dictionary->parameters[i]));
   } 
   c=i;
   for(i=c;i<sizeof(settings_settings)/sizeof(yamlsettings_parameter)+c;i++){
       yamlsettings_copy_parameter(&(settings_settings[i-c]),&(dictionary->parameters[i]));
   } 
   c=i;
   for(i=c;i<sizeof(settings_input)/sizeof(yamlsettings_parameter)+c;i++){
       yamlsettings_copy_parameter(&(settings_input[i-c]),&(dictionary->parameters[i]));
   } 
   // Copying parameters for input drivers
    for (idriver = 0; idriver < grasp_input_ndrivers(); idriver++) {
       if(driver_parameters[idriver]!=NULL){
           c=i;
           for(i=c;i<driver_parameters[idriver]->nparameters+c;i++){
                grasp_settings_copy_parameter(&(driver_parameters[idriver]->parameters[i-c]),&(dictionary->parameters[i]),GRASP_EXTENSION_DRIVER,grasp_input_driver_get_name(idriver));
           } 
           grasp_settings_parameter_array_destroy(driver_parameters[idriver]);
       }
    }   
   trackmem_free(driver_parameters);
   // For transformers
    for (itransformer = 0; itransformer < grasp_input_ntransformers(); itransformer++) {
       if(transformer_parameters[itransformer]!=NULL){
           c=i;
           for(i=c;i<transformer_parameters[itransformer]->nparameters+c;i++){
                grasp_settings_copy_parameter(&(transformer_parameters[itransformer]->parameters[i-c]),&(dictionary->parameters[i]),GRASP_EXTENSION_TRANSFORMER,grasp_input_transformer_get_name(itransformer));
           } 
           grasp_settings_parameter_array_destroy(transformer_parameters[itransformer]);
       }
    }   
   trackmem_free(transformer_parameters);
   
   c=i;
   for(i=c;i<sizeof(settings_output)/sizeof(yamlsettings_parameter)+c;i++){
       yamlsettings_copy_parameter(&(settings_output[i-c]),&(dictionary->parameters[i]));
   } 
   // Copying parameters for segment functions 
    for (ifunction = 0; ifunction < grasp_output_segment_nfunctions(); ifunction++) {
       if(segment_function_parameters[ifunction]!=NULL){
           c=i;
           for(i=c;i<segment_function_parameters[ifunction]->nparameters+c;i++){
                grasp_settings_copy_parameter(&(segment_function_parameters[ifunction]->parameters[i-c]),&(dictionary->parameters[i]), GRASP_EXTENSION_SEGMENT_FUNCTION,grasp_output_segment_function_get_name(ifunction));
           } 
           grasp_settings_parameter_array_destroy(segment_function_parameters[ifunction]);
       }
    }   
   trackmem_free(segment_function_parameters);
   c=i;
   // Copying parameters for tile functions 
    for (ifunction = 0; ifunction < grasp_output_tile_nfunctions(); ifunction++) {
       if(tile_function_parameters[ifunction]!=NULL){
           c=i;
           for(i=c;i<tile_function_parameters[ifunction]->nparameters+c;i++){
               grasp_settings_copy_parameter(&(tile_function_parameters[ifunction]->parameters[i-c]),&(dictionary->parameters[i]), GRASP_EXTENSION_TILE_FUNCTION,grasp_output_tile_function_get_name(ifunction));
           } 
           grasp_settings_parameter_array_destroy(tile_function_parameters[ifunction]);
       }
    }   
   trackmem_free(tile_function_parameters);
   c=i;
   // Copying parameters for current functions 
    for (ifunction = 0; ifunction < grasp_output_current_nfunctions(); ifunction++) {
       if(current_function_parameters[ifunction]!=NULL){
           c=i;
           for(i=c;i<current_function_parameters[ifunction]->nparameters+c;i++){
               grasp_settings_copy_parameter(&(current_function_parameters[ifunction]->parameters[i-c]),&(dictionary->parameters[i]), GRASP_EXTENSION_CURRENT_FUNCTION,grasp_output_current_function_get_name(ifunction));
           } 
           grasp_settings_parameter_array_destroy(current_function_parameters[ifunction]);
       }
    }   
   trackmem_free(current_function_parameters);
   c=i;
   
   for(i=c;i<sizeof(settings_controller)/sizeof(yamlsettings_parameter)+c;i++){
       yamlsettings_copy_parameter(&(settings_controller[i-c]),&(dictionary->parameters[i]));
   } 
   
   return dictionary;
}

void grasp_settings_postprocess_function(yamlsettings_dictionary_t *dictionary){
    grasp_settings_calculate_ndim_part(dictionary);
    grasp_settings_calculate_iwl_and_key(dictionary); 
    grasp_settings_input_method(dictionary);
    grasp_settings_simulated_sdata(dictionary);
    grasp_settings_controller_perform_retrieval(dictionary);
}

/**
 * Function which dumps grasp settings in yaml format
 * @param stream_pattern Patter to initialize grasp_output_stream
 * @param settings Current settings you want to dump
 * @param print_defaults if you want to print default values or you prefer a reduced settings file based on only set information
 * @return 0 if everything was ok, otherwise a value different than 0
 */
int grasp_settings_dump(char *stream_pattern, grasp_settings *settings, bool print_defaults){
    grasp_output_stream tmp_stream;
    FILE *f;
    yamlsettings_dictionary_t *dictionary; 
    
    yamlsettings_dictionary_t *reference_dictionary; 
    grasp_settings reference_settings;

    // Dump short settings if stream is defined
    grasp_output_stream_initialize(stream_pattern, &tmp_stream);
    f=grasp_output_stream_open(&tmp_stream, settings, NULL, NULL, NULL, -1, -1, -1);
    if(grasp_output_stream_writable(&tmp_stream)==true){ // If it is not writable, close stream and finish function
        // Get dictionary for allocated settings
        dictionary=grasp_settings_dictionary_get(settings);
        
        reference_dictionary=grasp_settings_dictionary_get(&reference_settings);
        yamlsettings_initialize_dictionary(reference_dictionary,"none");
        yamlsettings_initialize_dictionary(dictionary,"none"); 
        yamlsettings_dictionary_set_defaults(reference_dictionary);        

        yamlsettings_dump(f, dictionary, print_defaults, reference_dictionary);
    }   
    grasp_output_stream_close(&tmp_stream);
    grasp_output_stream_destroy(&tmp_stream);    
    
   return 0;
}

int grasp_settings_read(grasp_output_stream *controller_stream, yamlsettings_dictionary_t **dictionary, int nparameters, char const *parameters[]){
    int i, errors;
    grasp_settings *settings;
    
    // Allocate settings
    settings=(grasp_settings *)trackmem_malloc(sizeof(grasp_settings));
    assert(settings!=NULL);

    // Get dictionary for allocated settings
    *dictionary=grasp_settings_dictionary_get(settings);

    // Read file
    errors=yamlsettings_read_file(*dictionary, nparameters,parameters, NULL, grasp_settings_postprocess_function, YS_PARSE_SETTINGS_FILE_MANDATORY);

    // Initialize controller stream
    grasp_output_stream_initialize(((grasp_settings *)((*dictionary)->settings))->controller.stream_pattern, controller_stream);
    grasp_output_stream_open(controller_stream, NULL, NULL, NULL, NULL, -1, -1, -1);
    
    // If help argument is in list of arguments, even if there are problems we will print help and finish 
    if(strcmp(((grasp_settings *)((*dictionary)->settings))->settings.help,".")!=0){
        grasp_settings_help(controller_stream, ((grasp_settings *)((*dictionary)->settings))->settings.help);
        grasp_output_stream_destroy(controller_stream);
        yamlsettings_dictionary_complete_destroy(*dictionary);
        exit(0);
    }    
    
    // If version argument is in list of arguments, even if there are problems we will print version information and finish 
    if(((grasp_settings *)((*dictionary)->settings))->settings.version){
        grasp_version_print(stdout);
        grasp_output_stream_destroy(controller_stream);
        yamlsettings_dictionary_complete_destroy(*dictionary);
        exit(0);
    }        

    // But if there was no help argument we will print errors and continue
    if(yamlsettings_error_number_parse_error(&(*dictionary)->status, YS_FATAL_ERROR)>0){
        for (i = 0; i < (*dictionary)->status.parse_errors->len; i++) {
            if(((yamlsettings_parse_error *)((*dictionary)->status.parse_errors->pdata[i]))->type==YS_FATAL_ERROR){
                gos_fprintf(controller_stream, "ERROR: %s\n", ((yamlsettings_parse_error *)((*dictionary)->status.parse_errors->pdata[i]))->message );
            }
        }   
        grasp_output_stream_destroy(controller_stream);
        yamlsettings_dictionary_complete_destroy(*dictionary);
        exit(-1);
    }
    
    // If settings.debug is set we print debug information
    if (strcmp(((grasp_settings *)((*dictionary)->settings))->settings.debug,".")!=0) {
        yamlsettings_debug_dictionary(controller_stream->file,
                *dictionary,
                ((grasp_settings *)((*dictionary)->settings))->settings.debug);
        grasp_output_stream_destroy(controller_stream);
        yamlsettings_dictionary_complete_destroy(*dictionary);  
        exit(0);
    }    
    
    // Print parse errors
    for (i = 0; i < (*dictionary)->status.parse_errors->len; i++) {
        if(((yamlsettings_parse_error *)((*dictionary)->status.parse_errors->pdata[i]))->type==YS_ERROR){
            gos_fprintf(controller_stream, "ERROR: ");
        }else if(((yamlsettings_parse_error *)((*dictionary)->status.parse_errors->pdata[i]))->type==YS_FATAL_ERROR){
            gos_fprintf(controller_stream, "ERROR: ");
        }else if(((yamlsettings_parse_error *)((*dictionary)->status.parse_errors->pdata[i]))->type==YS_WARNING){
            gos_fprintf(controller_stream, "WARNING: ");
        }else if(((yamlsettings_parse_error *)((*dictionary)->status.parse_errors->pdata[i]))->type==YS_INFO){
            gos_fprintf(controller_stream, "INFO: ");
        }
        gos_fprintf(controller_stream, "%s\n", ((yamlsettings_parse_error *)((*dictionary)->status.parse_errors->pdata[i]))->message );
    }

    // Print validator erros if there are not parse errors
    for (i = 0; i < (*dictionary)->status.validation_errors->len; i++) {
        gos_fprintf(controller_stream, "ERROR: %s\n", ((yamlsettings_validation_error *)((*dictionary)->status.validation_errors->pdata[i]))->message );
    }   

    // Print error summary
    if((yamlsettings_error_number_parse_error(&(*dictionary)->status, YS_ERROR) + yamlsettings_error_number_parse_error(&(*dictionary)->status, YS_WARNING) + yamlsettings_error_number_validation_error(&(*dictionary)->status) )>0){
        gos_fprintf(controller_stream, "Summarizing settings problems: %d parse warnings, %d parse errors, %d validation errors\n", 
                yamlsettings_error_number_parse_error(&(*dictionary)->status, YS_WARNING), 
                yamlsettings_error_number_parse_error(&(*dictionary)->status, YS_ERROR), 
                yamlsettings_error_number_validation_error(&(*dictionary)->status));
        
        if(((grasp_settings *)((*dictionary)->settings))->settings.strict==true){
            //gos_fprintf(controller_stream, "If you want to force the execution set settings.strict parameter to false\n");
            grasp_output_stream_destroy(controller_stream);
            yamlsettings_dictionary_complete_destroy(*dictionary);
            exit(-1);
        }else{
            gos_fprintf(controller_stream, "The execution will continue because settings.strict is true\n");
        }
    }
    
    // Dump short settings if stream is defined
    grasp_settings_dump(settings->settings.short_dump, settings, false);
    grasp_settings_dump(settings->settings.long_dump, settings, true);   

    return errors;
}

void grasp_settings_help(grasp_output_stream *controller_stream, const char *filter){
    yamlsettings_dictionary_t *dictionary;
    grasp_settings *settings;
    
    // Create a dictionary for retrive help information
    settings=(grasp_settings *)trackmem_malloc(sizeof(grasp_settings));
    assert( settings!= NULL);
    dictionary=grasp_settings_dictionary_get(settings);
    yamlsettings_initialize_dictionary(dictionary, "");
       
    if(grasp_output_stream_writable(controller_stream)==false){
        fprintf(stderr, "ERROR: Help information can not be printed if controller output stream is not writable");
        abort();
    }
    yamlsettings_print_help_information(controller_stream->file, dictionary, filter);
    
    // Deallocate dictioanry
    yamlsettings_dictionary_complete_destroy(dictionary);
}

void grasp_settings_destroy(grasp_settings *settings){    
    trackmem_free(settings);
}

grasp_settings_parameter_array *grasp_settings_parameter_array_allocate(int nelements){
    grasp_settings_parameter_array *result;
    
    result = (grasp_settings_parameter_array *) trackmem_malloc(sizeof (grasp_settings_parameter_array));
    assert( result!= NULL);
    
    result->nparameters=nelements;
    
    result->parameters = (yamlsettings_parameter *) trackmem_malloc(sizeof (yamlsettings_parameter)*result->nparameters);    
    assert( result->parameters!= NULL);
    
    return result;
}


void grasp_settings_parameter_array_destroy(grasp_settings_parameter_array *x){    
    trackmem_free(x->parameters);    
    trackmem_free(x);
}


// PRIVATE FUCNTION
// This function wraps yamlsettings_copy_parameter from libyamlsettings library
// adding the functionaly to add classification block for extension settings.
void grasp_settings_copy_parameter(yamlsettings_parameter *origin, yamlsettings_parameter *dest, grasp_settings_type_parameter extension_type, const char *extension_name){
    char *tmp;
    
    // We use libyamlsettings function to copy all fields
    yamlsettings_copy_parameter(origin,dest);
    
    // But then, we customize the way to copy name
    if(extension_type!=GRASP_NO_EXTENSION){
        tmp = (char *) malloc(sizeof (char)* (50+strlen(origin->name)+strlen(extension_name)));
    }  
    
    switch (extension_type){
        case GRASP_NO_EXTENSION:
            break;
        case GRASP_EXTENSION_DRIVER:
            strcpy(tmp,"input.driver_settings.");  
            break;
        case GRASP_EXTENSION_TRANSFORMER:
            strcpy(tmp,"input.transformer_settings.");  
            break;
        case GRASP_EXTENSION_SEGMENT_FUNCTION:
            strcpy(tmp,"output.segment.function_settings.");  
            break;
        case GRASP_EXTENSION_CURRENT_FUNCTION:
            strcpy(tmp,"output.current.function_settings.");  
            break;
        case GRASP_EXTENSION_TILE_FUNCTION:
            strcpy(tmp,"output.tile.function_settings.");  
            break;
        default:
            fprintf(stderr, "%s:%d: ERROR: Unknown value of extension_type argument (value: %d)\n", __FILE__, __LINE__, extension_type);
            abort();
    }
    
    if(extension_type!=GRASP_NO_EXTENSION){
        strcat(tmp,extension_name);
        strcat(tmp,".");
        strcat(tmp,origin->name);
        dest->name=tmp;
        dest->name_deallocatable=true;  
    }
}

